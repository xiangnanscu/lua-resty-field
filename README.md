# lua-resty-field
Transform value via a field object.

# Requirements
[lua-resty-validator](https://github.com/openresty/lua-resty-validator)

# Synopsis
```
local Field = require "resty.field"
local username = Field.string{maxlength=3, no_whitespaces=true}
local session = Field.json{}
local add_suffix = function(v) return v..' address suffix.' end
local address = Field.string{maxlength=50, validators={add_suffix}}
local res = {}
res.v1, res.e1 = username.client_to_lua('abcd')
res.v2, res.e2 = session.client_to_lua('{"foo":"bar"}')
res.v3, res.e3 = session.lua_to_db(res.v2)
res.v4, res.e4 = address.client_to_lua('No.1 street')
-- res will be: {"e1":"字数不能多于3个","v3":"{\"foo\":\"bar\"}","v2":{"foo":"bar"},"v4":"No.1 street address suffix."}
```
# field classes
use them like
## basefield
class basefield defines common options and validate logic for all field classes.
### field.required
`true` or `false`. Specify whether value should be provided for this field.
### field.null
`true` or `false`. Specify whether value could be NULL when saved to database.
### field.name
`string`. The corresponding database column name for this field.
### field.label
`string`. Name used as form label. `field.name` will be used if not provided.
### field.default
`any`. default value when method `field.lua_to_db` is called. If it's a function, returned value of `field.default()` is used, otherwise `field.default` is used.
### field.error_messages
`table`. Custom the error messages like `{maxlength:'too long', required:'cannot be blank'}`.Currently you can set required|maxlength|minlength|length|max|min.
### field.validators
`table`. Should be a table like `{client_to_lua:{...}, lua_to_db:{...}, db_to_lua:{...}, lua_to_client:{...}}` where `{...}` should be a list of [validators](https://github.com/xiangnanscu/lua-resty-validator). You can also define validators like `{...}` which is equivalent to `{client_to_lua:{...}}`.
### field.get_empty_value_to_update
`method`. If an empty value(usually empty string) is provided for this field, what value should be actually sent to database.
### field.choices
`function` or `table`. Valid value list for this field. Standard form is like `{{value='v1', label='l1'},{value='v2', label='l2'}, ...}`. You could define a simple form like `{'v1', 'v2'}` which is equivalent to `{{value='v1', label='v1'},{value='v2', label='v2'}`. You could also define it as a function which should return choices in standard form.
### field.(client_to_lua|lua_to_db|db_to_lua|lua_to_client)
`function`. Core validation logic of the field. If not provided, it will be generated by validators. When a [Model](https://github.com/xiangnanscu/lua-resty-model) `save` method is called, `client_to_lua` and `lua_to_db` is invoked in sequence. When loading a model instance from database, `db_to_lua` is called.  
### field._options
shallow copy of the table passed to `field.new` method.

## string
### string.(maxlength|minlength|length)
`number`. define max length/min length/length of this field. You **must** define at least one of them.
### string.pattern
`string`. Define a PCRE regex for this field. Used in [ngx.re.match](https://github.com/openresty/lua-nginx-module#ngxrematch) with `jo`.
### string.trim
`true` or `false`. Whether delete leading and trailing whitespaces.Default is `true`.
### string.no_whitespaces
`true` or `false`. Whether delete all whitespaces in this field. Default is `false`.
## integer
### integer.(min|max)
`number`. max/min value of this field.
## float
### float.(min|max)
`number`. max/min value of this field.
### float.precison
`number`. precison of float. Database related. 
## datetime
### datetime.timezone
`true` or `false`. Used when creating database tables.
### datetime.precision
`number`. Used when creating database tables.
### datetime.auto_now_add
`true` or `false`. If true, automatically set current time when creating a record. Note, `client_to_lua` will be set by this flag, so you shouldn't provide any validators in this stage.
### datetime.auto_now
`true` or `false`. If true, automatically set current time when updating a record. Note, `client_to_lua` and `lua_to_db` will be set by this flag, so you shouldn't provide any validators in these two stages.
## date
## time
### datetime.timezone
`true` or `false`. Used when creating database tables.
### datetime.precision
`number`. Used when creating database tables.
## json
inherited from `string` field. it's implemented as `varchar` in database. Default maxlength is 3000.
## array
inherited from `json` field. 
## table
inherited from `array` field. You should always define `subfields` for this field.
## foreignkey
### foreignkey.reference
A [Model](https://github.com/xiangnanscu/lua-resty-model).
### foreignkey.reference_column
Which column is refered. Default is `id`. Note valid field type is string, integer, float, datetime, date and time.
## boolean
